<!DOCTYPE html>
<html>
  <head>
    <link>
    <link rel="stylesheet" href="bootstrap.min.css">
    <link rel="stylesheet" href="index.css">
    <link href='https://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css'>

    <title>Twittler</title>

    <script src="jquery.js"></script>
    <script src="bootstrap.min.js"></script>
    <script src="data_generator.js"></script>
  </head>
  <body>
    <div class="col-xs-7 leftBlock">
      <div class="welcome">
        <h1 align="center">Welcome to Twittler</h1>
        <h3 align="center">What's on Your Mind?</h3>
      </div>
      <div class="container formContainer" style="width:initial">
        <form class="newPostForm">
          <textarea type="text" name="createPost" placeholder="Start typing here!"></textarea>
          <input type="submit" class='pull-right'>
        </form>
      </div>
      <div class="autoUpdateCheckbox">
        <form>
          <b class="checkboxText">Auto-Update list as new messages are posted&nbsp;
            <input type="checkbox" name="autoUpdate" value="true" class="autoUpdate" checked>
          </b>
        </form>
      </div>
    </div>

    <div class="col-xs-5 rightBlock">
      <div class="col-xs-4 logo"></div>
      <div class="col-xs-offset-1 col-xs-7 topBar"></div>
      <div class="postHeader">
        <h1 align="center">Newest Twittles</h1>
      </div>
      <div class="trendingBox">
        <h5 align="center">Trending:</h5>
      </div>
      <div class="postsArea">
        <ul class="postsList">
          <!-- Posts from data_generator.js inserted here -->
        </ul>
      </div>
    </div>

    <script>

      $(document).ready(function(){

        // init streams length, total height of post area, and height of all current posts
        var index = streams.home.length - 1;
        var totalCurrPostHeight = 0;
        var postsListHeight = $('.postsList').height();
        
        // display initial posts
        while(totalCurrPostHeight < postsListHeight+50) {
          var postsListHeight = $('.postsList').height();
          var postTextInfo, postHeight, postTextHeight, postMargin;
          var tweet = streams.home[index];

          // create dynamic post template
          $('.postsList').prepend(`
            <li>
              <div class="col-xs-1 profilePic"></div>
              <div class="col-xs-9 postText">
              <b>@${tweet.user}</b>
              <br>
              <i>${tweet.created_at}</i>
              <br>
              <p>${tweet.message} >> ${tweet.id}</p>
            </div>
            </li>
          `)
          ;
          postTextInfo = $('.postsList').children('li'); // alias for every post thus far

          postHeight = $(postTextInfo[postTextInfo.length-1]).find('.postText').height(); // height of current post in px
          postTextHeight = $(postTextInfo[postTextInfo.length-1]).find('.postText p').height(); // height of current post minus username and date
          postMargin = (postHeight/postTextHeight)*5; // calculate margin between posts

          // apply margins and calculate height of all posts thus far
          $(postTextInfo[postTextInfo.length-1]).find('p').css('margin-bottom', postMargin+'px');
          totalCurrPostHeight += postHeight+postMargin;

          index--;
        }

        // custom jquery event listener for adding to array
        $(window).on('addPost', function() {
          var tweet = streams.home[index+1];

          var oldScroll = $('.postsList').scrollTop();

          // if box unchecked, set following post css to not display
          $('.autoUpdate')[0].checked === false ? tweet.hidden = 'style="display: none;"' : tweet.hidden = 'style="display: block;"';

          $('.postsList').prepend(`
            <li ${tweet.hidden}>
              <div class="col-xs-1 profilePic"></div>
              <div class="col-xs-9 postText">
              <b>@${tweet.user}</b>
              <br>
              <i>${tweet.created_at}</i>
              <br>
              <p>${tweet.message} || ${tweet.id}</p>
            </div>
            </li>
          `)
          ;

          if (oldScroll) {
            var newPostHeight = $('.postsList li:last .postText').outerHeight();
            $('.postsList').scrollTop(oldScroll+newPostHeight-8)
          }
        })

        // change all post css to display: block (ensures nothing was skipped while box was unchecked)
        $('.autoUpdate').change(function() {
          if (this.checked) {
            $('li').css('display', 'block')
          }
        })
      });

    </script>
  </body>
</html>
